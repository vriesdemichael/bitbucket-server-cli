name: Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: Release version tag (for example v0.1.0)
        required: true
        type: string

permissions:
  contents: write

jobs:
  release:
    name: Publish Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Validate version input
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          if [[ ! "$VERSION" =~ ^v[0-9]+\.[0-9]+\.[0-9]+([.-][0-9A-Za-z.-]+)?$ ]]; then
            echo "Version must look like vMAJOR.MINOR.PATCH (optionally with prerelease/build suffix)."
            exit 1
          fi

      - name: Ensure release tag does not already exist
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists."
            exit 1
          fi

      - name: Generate changelog from Conventional Commits
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          LAST_TAG="$(git describe --tags --abbrev=0 2>/dev/null || true)"
          RANGE=""
          if [[ -n "$LAST_TAG" ]]; then
            RANGE="$LAST_TAG..HEAD"
          fi

          mapfile -t COMMITS < <(git log --no-merges --pretty=format:%s $RANGE)

          {
            echo "## $VERSION"
            echo
            if [[ -n "$LAST_TAG" ]]; then
              echo "Changes since $LAST_TAG."
            else
              echo "Initial release changes."
            fi
            echo

            declare -a FEAT FIX PERF REFACTOR DOCS TEST BUILD CI CHORE OTHER
            for SUBJECT in "${COMMITS[@]}"; do
              case "$SUBJECT" in
                feat\(*|feat:*) FEAT+=("$SUBJECT") ;;
                fix\(*|fix:*) FIX+=("$SUBJECT") ;;
                perf\(*|perf:*) PERF+=("$SUBJECT") ;;
                refactor\(*|refactor:*) REFACTOR+=("$SUBJECT") ;;
                docs\(*|docs:*) DOCS+=("$SUBJECT") ;;
                test\(*|test:*) TEST+=("$SUBJECT") ;;
                build\(*|build:*) BUILD+=("$SUBJECT") ;;
                ci\(*|ci:*) CI+=("$SUBJECT") ;;
                chore\(*|chore:*) CHORE+=("$SUBJECT") ;;
                *) OTHER+=("$SUBJECT") ;;
              esac
            done

            write_section() {
              local heading="$1"
              shift
              local entries=("$@")
              if [[ ${#entries[@]} -eq 0 ]]; then
                return
              fi
              echo "### $heading"
              for item in "${entries[@]}"; do
                echo "- $item"
              done
              echo
            }

            write_section "Features" "${FEAT[@]}"
            write_section "Fixes" "${FIX[@]}"
            write_section "Performance" "${PERF[@]}"
            write_section "Refactors" "${REFACTOR[@]}"
            write_section "Docs" "${DOCS[@]}"
            write_section "Tests" "${TEST[@]}"
            write_section "Build" "${BUILD[@]}"
            write_section "CI" "${CI[@]}"
            write_section "Chores" "${CHORE[@]}"
            write_section "Other" "${OTHER[@]}"
          } > RELEASE_NOTES.md

      - name: Create and push annotated tag
        env:
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git tag -a "$VERSION" -m "Release $VERSION"
          git push origin "$VERSION"

      - name: Publish GitHub release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ inputs.version }}
        run: |
          set -euo pipefail
          gh release create "$VERSION" --title "$VERSION" --notes-file RELEASE_NOTES.md